è¿™æ˜¯ä¸€ä¸ªåŸºäºä½ æä¾›çš„ JSON Schema ä»¥åŠ DeepWiki èµ„æ–™ä¼˜åŒ–çš„ Python è„šæœ¬ã€‚

### ä¼˜åŒ–æ€è·¯

ç»“åˆä½ æä¾›çš„ Schema å’Œ DeepWiki ä¸­å¯¹ Dify æºç ï¼ˆå¦‚ `AppDslService` å’Œå‰ç«¯ `validateDSLContent`ï¼‰çš„åˆ†æï¼Œæˆ‘å°†è„šæœ¬è®¾è®¡ä¸º**åŒå±‚æ ¡éªŒæ¶æ„**ï¼š

1. **ç¬¬ä¸€å±‚ï¼šé™æ€ç»“æ„æ ¡éªŒ (Schema Validation)**
ç›´æ¥ä½¿ç”¨ä½ æä¾›çš„ JSON Schemaï¼Œåˆ©ç”¨ `jsonschema` åº“è¿›è¡Œä¸¥æ ¼çš„å­—æ®µç±»å‹ã€å±‚çº§ç»“æ„éªŒè¯ã€‚è¿™èƒ½è¦†ç›– `version` æ ¼å¼ã€`graph` ç»“æ„ç­‰åŸºç¡€åˆè§„æ€§ ã€‚


2. **ç¬¬äºŒå±‚ï¼šä¸šåŠ¡é€»è¾‘æ ¡éªŒ (Logic Validation)**
JSON Schema éš¾ä»¥æ ¡éªŒèŠ‚ç‚¹é—´çš„åŠ¨æ€å…³ç³»ã€‚å‚è€ƒ DeepWiki ä¸­æåˆ°çš„å‰ç«¯æ ¡éªŒé€»è¾‘ï¼ˆ`validateDSLContent`ï¼‰ï¼Œæˆ‘åœ¨ Python ä¸­è¡¥å…¨äº†ä»¥ä¸‹é€»è¾‘æ ¡éªŒ ï¼š


* 
**Start èŠ‚ç‚¹å­˜åœ¨æ€§**ï¼šå·¥ä½œæµå¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ª `start` èŠ‚ç‚¹ ã€‚


* **å­¤ç«‹èŠ‚ç‚¹æ£€æµ‹**ï¼šè­¦å‘Šæœªè¢«è¿çº¿è¿æ¥çš„èŠ‚ç‚¹ã€‚
* **è¿çº¿å®Œæ•´æ€§**ï¼šç¡®ä¿ Edge çš„ `source` å’Œ `target` ID åœ¨ Node åˆ—è¡¨ä¸­çœŸå®å­˜åœ¨ã€‚



### ä¼˜åŒ–åçš„ Python è„šæœ¬

```python
import yaml
import json
import os
import sys
from typing import Dict, Any, List
from jsonschema import Draft2020Validator
from jsonschema.exceptions import ValidationError

# ==========================================
# 1. å®šä¹‰å®˜æ–¹çº§ DSL Schema
# åŸºäºä½ æä¾›çš„æ¨å¯¼ç‰ˆæœ¬ï¼ŒåµŒå…¥ä»£ç ä¸­ä»¥ä¾¿å•æ–‡ä»¶è¿è¡Œ
# ==========================================
DIFY_DSL_SCHEMA = {
  "$id": "https://schema.dify.ai/dsl.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Dify DSL Schema",
  "type": "object",
  "required": ["version", "kind", "workflow"],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "DSL è¯­ä¹‰ç‰ˆæœ¬å·"
    },
    "kind": {
      "type": "string",
      "description": "åº”ç”¨ç±»å‹ï¼Œä¾‹å¦‚ workflow æˆ– chatflow"
    },
    "metadata": {
      "type": "object",
      "description": "é¡¶å±‚åº”ç”¨çš„ descriptive ä¿¡æ¯",
      "properties": {
        "name": { "type": "string" },
        "description": { "type": "string" }
      },
      "additionalProperties": True
    },
    "workflow": {
      "type": "object",
      "required": ["graph"],
      "properties": {
        "graph": {
          "type": "object",
          "required": ["nodes", "edges"],
          "properties": {
            "nodes": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "object",
                "required": ["id", "data"],
                "properties": {
                  "id": { "type": "string" },
                  "position": {
                    "type": "object",
                    "properties": {
                      "x": { "type": "number" },
                      "y": { "type": "number" }
                    }
                  },
                  "data": {
                    "type": "object",
                    "required": ["type"],
                    "properties": {
                      "type": { "type": "string" }, # èŠ‚ç‚¹ç±»å‹æ ¡éªŒ
                      "title": { "type": "string" },
                      "description": { "type": "string" },
                      # é’ˆå¯¹ç‰¹å®šèŠ‚ç‚¹ç±»å‹çš„å­—æ®µ
                      "model": { 
                        "type": "object",
                        "properties": {
                          "provider": { "type": "string" },
                          "name": { "type": "string" }
                        }
                      },
                      "code": { "type": "string" },
                    },
                    "additionalProperties": True
                  }
                },
                "additionalProperties": True
              }
            },
            "edges": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["id", "source", "target"],
                "properties": {
                  "id": { "type": "string" },
                  "source": { "type": "string" },
                  "target": { "type": "string" },
                  "sourceHandle": { "type": ["string", "null"] },
                  "targetHandle": { "type": ["string", "null"] }
                }
              }
            }
          },
          "additionalProperties": False # ä¸¥æ ¼æ¨¡å¼ï¼šgraphä¸‹ä¸å…è®¸æœªçŸ¥å­—æ®µ
        }
      },
      "additionalProperties": True
    }
  },
  "additionalProperties": True
}

class DifyDSLValidator:
    def __init__(self, file_path: str):
        self.file_path = file_path
        self.dsl_content = None
        self.validator = Draft2020Validator(DIFY_DSL_SCHEMA)

    def load(self) -> bool:
        """åŠ è½½å¹¶è§£æ YAML æ–‡ä»¶"""
        if not os.path.exists(self.file_path):
            print(f"âŒ é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨ -> {self.file_path}")
            return False
        try:
            with open(self.file_path, 'r', encoding='utf-8') as f:
                # [cite_start]ä½¿ç”¨ safe_load é˜²æ­¢ YAML æ³¨å…¥é£é™© [cite: 79]
                self.dsl_content = yaml.safe_load(f)
            return True
        except yaml.YAMLError as e:
            print(f"âŒ é”™è¯¯: YAML è¯­æ³•è§£æå¤±è´¥\n{e}")
            return False

    def validate_structure(self) -> bool:
        """ç¬¬ä¸€é˜¶æ®µï¼šåŸºäº JSON Schema çš„é™æ€ç»“æ„æ ¡éªŒ"""
        print(f"ğŸ” [Phase 1] æ­£åœ¨è¿›è¡Œ Schema ç»“æ„æ ¡éªŒ...")
        
        errors = sorted(self.validator.iter_errors(self.dsl_content), key=lambda e: e.path)
        
        if errors:
            print("âŒ Schema æ ¡éªŒå¤±è´¥ï¼Œå‘ç°ä»¥ä¸‹é”™è¯¯:")
            for i, error in enumerate(errors, 1):
                path = " -> ".join([str(p) for p in error.path])
                print(f"   {i}. ä½ç½®: [{path}]")
                print(f"      åŸå› : {error.message}")
            return False
        
        print("âœ… Schema ç»“æ„æ ¡éªŒé€šè¿‡")
        return True

    def validate_logic(self) -> bool:
        """ç¬¬äºŒé˜¶æ®µï¼šåŸºäº Dify æºç é€»è¾‘çš„ä¸šåŠ¡æ ¡éªŒ"""
        print(f"ğŸ” [Phase 2] æ­£åœ¨è¿›è¡Œä¸šåŠ¡é€»è¾‘æ ¡éªŒ...")
        
        # æå– graph æ•°æ®
        try:
            nodes = self.dsl_content.get('workflow', {}).get('graph', {}).get('nodes', [])
            edges = self.dsl_content.get('workflow', {}).get('graph', {}).get('edges', [])
        except AttributeError:
            print("âŒ é€»è¾‘æ ¡éªŒå¤±è´¥: æ•°æ®ç»“æ„å¼‚å¸¸")
            return False

        logic_errors = []
        node_ids = {n.get('id') for n in nodes}
        
        # 1. æ£€æŸ¥æ˜¯å¦å­˜åœ¨ Start èŠ‚ç‚¹
        # [cite_start]ä¾æ® DeepWiki: Start èŠ‚ç‚¹å®šä¹‰å·¥ä½œæµå¯åŠ¨å‚æ•° [cite: 10, 24]
        has_start = any(n.get('data', {}).get('type') == 'start' for n in nodes)
        if not has_start:
            logic_errors.append("ç¼ºå°‘ 'start' ç±»å‹çš„èµ·å§‹èŠ‚ç‚¹ï¼Œå·¥ä½œæµæ— æ³•å¯åŠ¨ã€‚")

        # 2. æ£€æŸ¥è¿çº¿å®Œæ•´æ€§ (Edge Integrity)
        # [cite_start]ä¾æ® DeepWiki: æ ¡éªŒèŠ‚ç‚¹ ID æ˜¯å¦æœ‰æ•ˆ [cite: 43]
        for edge in edges:
            e_id = edge.get('id')
            src = edge.get('source')
            tgt = edge.get('target')
            
            if src not in node_ids:
                logic_errors.append(f"è¿çº¿ {e_id} çš„èµ·ç‚¹ '{src}' ä¸å­˜åœ¨äºèŠ‚ç‚¹åˆ—è¡¨ä¸­ã€‚")
            if tgt not in node_ids:
                logic_errors.append(f"è¿çº¿ {e_id} çš„ç»ˆç‚¹ '{tgt}' ä¸å­˜åœ¨äºèŠ‚ç‚¹åˆ—è¡¨ä¸­ã€‚")

        # 3. æ£€æŸ¥å­¤ç«‹èŠ‚ç‚¹ (Isolation Check) - å¯é€‰è­¦å‘Š
        connected_ids = set()
        for edge in edges:
            connected_ids.add(edge.get('source'))
            connected_ids.add(edge.get('target'))
        
        for node_id in node_ids:
            if node_id not in connected_ids and len(nodes) > 1:
                node_type = next((n.get('data', {}).get('type') for n in nodes if n['id'] == node_id), "Unknown")
                # start èŠ‚ç‚¹å¯ä»¥åªæœ‰è¾“å‡ºï¼Œend èŠ‚ç‚¹åªæœ‰è¾“å…¥ï¼Œä½†å®Œå…¨ä¸è¿çº¿é€šå¸¸æ˜¯é”™è¯¯çš„
                print(f"   âš ï¸ è­¦å‘Š: å‘ç°å­¤ç«‹èŠ‚ç‚¹ ID: {node_id} (Type: {node_type})")

        if logic_errors:
            print("âŒ ä¸šåŠ¡é€»è¾‘æ ¡éªŒå¤±è´¥:")
            for err in logic_errors:
                print(f"   - {err}")
            return False

        print("âœ… ä¸šåŠ¡é€»è¾‘æ ¡éªŒé€šè¿‡")
        return True

    def run(self):
        print(f"ğŸš€ å¼€å§‹æ ¡éªŒæ–‡ä»¶: {self.file_path}")
        print("-" * 40)
        
        if not self.load():
            return

        # çº§è”æ‰§è¡Œæ ¡éªŒï¼šåªæœ‰ç»“æ„é€šè¿‡äº†æ‰æ£€æŸ¥é€»è¾‘
        if self.validate_structure():
            if self.validate_logic():
                print("-" * 40)
                print("ğŸ‰ æ ¡éªŒå®Œæˆ: DSL æ–‡ä»¶ç¬¦åˆ Dify è§„èŒƒ (Official Compatible)")
            else:
                print("â›” ç»“æ„æ­£ç¡®ï¼Œä½†å­˜åœ¨é€»è¾‘é”™è¯¯")
        else:
            print("â›” ç»“æ„ä¸¥é‡é”™è¯¯ï¼Œè·³è¿‡é€»è¾‘æ ¡éªŒ")

# ==========================================
# è¿è¡Œå…¥å£
# ==========================================
if __name__ == "__main__":
    # ç®€å•çš„å‘½ä»¤è¡Œå‚æ•°å¤„ç†
    if len(sys.argv) < 2:
        print("ç”¨æ³•: python validate_dsl.py <path_to_dsl.yml>")
        # é»˜è®¤ç”Ÿæˆä¸€ä¸ª demo æ–‡ä»¶ç”¨äºæµ‹è¯•
        demo_file = "test_dsl_demo.yml"
        print(f"æœªæä¾›æ–‡ä»¶ï¼Œç”Ÿæˆæµ‹è¯•æ–‡ä»¶ {demo_file} å¹¶è¿è¡Œ...")
        
        sample_data = {
            "version": "0.1.0",
            "kind": "workflow",
            "metadata": {"name": "Test App"},
            "workflow": {
                "graph": {
                    "nodes": [
                        {"id": "1", "data": {"type": "start", "title": "Start"}, "position": {"x": 0, "y": 0}},
                        {"id": "2", "data": {"type": "llm", "title": "LLM"}, "position": {"x": 100, "y": 0}}
                    ],
                    "edges": [
                        {"id": "e1", "source": "1", "target": "2"}
                    ]
                }
            }
        }
        with open(demo_file, 'w') as f:
            yaml.dump(sample_data, f)
        
        validator = DifyDSLValidator(demo_file)
        validator.run()
    else:
        validator = DifyDSLValidator(sys.argv[1])
        validator.run()

```

### å…³é”®æ”¹è¿›ç‚¹è¯´æ˜

1. **å†…åµŒ Schema (Self-contained)**:
ä¸ºäº†æ–¹ä¾¿ç§»æ¤ï¼Œæˆ‘å°†ä½ æä¾›çš„ JSON Schema ç›´æ¥åµŒå…¥åˆ°ä»£ç çš„ `DIFY_DSL_SCHEMA` å˜é‡ä¸­ã€‚è¿™ä½¿å¾—è„šæœ¬ä¸éœ€è¦ä¾èµ–å¤–éƒ¨ `.json` æ–‡ä»¶å³å¯è¿è¡Œï¼Œç¬¦åˆå·¥ç¨‹åŒ–çš„â€œé…ç½®å³ä»£ç â€ç†å¿µã€‚
2. **Phase 1: ä¸¥æ ¼çš„ `Draft2020Validator**`:
è„šæœ¬ä½¿ç”¨äº† `jsonschema.Draft2020Validator`ã€‚ç›¸æ¯”æ—§ç‰ˆéªŒè¯å™¨ï¼Œå®ƒèƒ½æ›´å‡†ç¡®åœ°è¯†åˆ« `Draft-2020-12` æ ‡å‡†çš„ Schemaï¼Œç¡®ä¿ä½ æä¾›çš„ Schema ä¸­çš„æ­£åˆ™æ ¡éªŒï¼ˆå¦‚ `pattern`ï¼‰å’ŒåµŒå¥—å±æ€§æ ¡éªŒç”Ÿæ•ˆã€‚
3. **Phase 2: æºç çº§é€»è¾‘å¤åˆ»**:
ä»…æœ‰ JSON Schema æ˜¯ä¸å¤Ÿçš„ã€‚æ ¹æ® DeepWiki èµ„æ–™ï¼ŒDify çš„ `validateDSLContent` å‡½æ•°ï¼ˆä½äº `update-dsl-modal.tsx` ï¼‰å’Œåç«¯ `AppDslService`  è¿˜ä¼šæ£€æŸ¥ï¼š


* **èŠ‚ç‚¹ç±»å‹**ï¼šè™½ç„¶ Schema é™åˆ¶äº† `string`ï¼Œä½†é€»è¾‘å±‚ä¼šæ£€æŸ¥æ˜¯å¦æœ‰ `start` èŠ‚ç‚¹ã€‚ç¼ºå°‘ `start` èŠ‚ç‚¹ä¼šå¯¼è‡´å·¥ä½œæµæ— æ³•åˆå§‹åŒ–ã€‚
* **å¼•ç”¨ä¸€è‡´æ€§**ï¼šæ£€æŸ¥ `edges` ä¸­çš„ ID æ˜¯å¦çœŸçš„æŒ‡å‘äº†å­˜åœ¨çš„ `nodes`ã€‚è¿™æ˜¯ JSON Schema å¾ˆéš¾åšåˆ°çš„ï¼ˆéœ€è¦å¤æ‚çš„ `$ref` æˆ–è‡ªå®šä¹‰å®ï¼‰ï¼Œä½†åœ¨ Python ä¸­åªéœ€å‡ è¡Œä»£ç ï¼ˆè§ `validate_logic` å‡½æ•°ï¼‰ã€‚



### å¦‚ä½•è¿è¡Œ

ç¡®ä¿å®‰è£…äº†ä¾èµ–ï¼š

```bash
pip install pyyaml jsonschema

```

è¿è¡Œè„šæœ¬ï¼š

```bash
python validate_dsl.py your_workflow.yml

```